# 前处理流程

目的：按以下流程执行脚本，从原数据中处理得到用于深度学习网络训练及测试的模型



## 总体流程：

① 按以下形式手动组织原数据文件夹树图表示如下

|---原数据

|------------棋盘格

|--------------------待校正光谱图像

|------------白色圆点光谱

|------------圆点目标物

|--------------------待校正光谱图像

|------------1

|--------------------待校正光谱图像

|--------------------色差模糊图像

|-------------2

|--------------------待校正光谱图像

|--------------------色差模糊图像

|------------...

|------------63

|--------------------待校正光谱图像

|--------------------色差模糊图像



② 运行CheckerboardCalibrating.m脚本 得到tform.mat数据，以550nm为基准波长



③ 运行rectify.m脚本 手工选择白点区域，得到a.mat数据



④ 在脚本集同目录下创建文件夹名字为“用于神经网络训练的数据” 



⑤ 运行PreProcess_andOrganize.m脚本 运行过程中手动选择光谱图像ROI1与色差模糊图像ROI2

​     脚本的对某个样本的处理为：对序列模糊图像进行配准到550nm(550nm会没有变化)---按照ROI2对模糊图像进行裁剪---对序列光谱图像进行配准到550nm---按照 ROI1对光谱图像进行裁剪---将裁剪后的光谱图像缩放到ROI2的大小。



⑥ 得到用于神经网络训练的数据文件夹树图表示如下，训练集56个样本，测试集7个样本, 每张光谱图像使用时应注意与a.mat中各波段的衰减系数相乘，才等于光谱辐照度量。

|---用于神经网络训练的数据

|------------For_Test

|-------------------------光谱图像

|-------------------------------------58

|-------------------------------------59

|-------------------------------------....

|-------------------------------------63

|-------------------------模糊图像

|-------------------------------------58

|-------------------------------------59

|-------------------------------------....

|-------------------------------------63

|------------For_Train

|-------------------------光谱图像

|-------------------------------------1

|-------------------------------------2

|-------------------------------------....

|-------------------------------------57

|-------------------------模糊图像

|-------------------------------------1

|-------------------------------------2

|-------------------------------------....

|-------------------------------------57

|------------a.mat





## 每个流程的补充说明

### CheckerboardCalibrating.m脚本-棋盘格校正

CheckerboardCalibrating.m 脚本基于棋盘格，提取配准点，得到色差模糊高光谱成像系
统的几何配准参数该几何配准参数仅适用于目标物固定情况设置下（物距，传输介质），
如果目标物设置情况改变，应重新得到几何配准参数。

需设置参数：① 棋盘格全幅待几何校正光谱图片的文件夹路径ImageFolder，因为图片需
                            有一定的亮度，所以可以图片可以不必经过透过率校正，否则匹配点识别
                            性能会降低。
                       ② 基准参考波长BaseWavelength，该波段得图片不会经几何变换，其他波
                            段的图片向该波段校准。

显示及保存：① 显示校正前后棋盘格与基准波段图像的叠加，配准效果越好，产生的重影
                            越小，选择的ROI为棋盘格区域，目的是为了让展示效果更佳明显，但配
                            准算法是作用于全幅图像的而不是ROI。
                       ② 保存tform.mat文件，tformCalibrating.m 可通过加载该文件对成像系
                            统得到的图片进行几何配准,大小为光谱照片的波段数。

### rectify.m脚本-透过率校正

rectify.m 脚本基于圆盘目标物/待校正光谱图像（几何校正后）与光谱仪测得的光谱曲
作比较，得到各波段的透过率校正参数，该透过率修正参数仅适用于目标物固定情况设置
 下（物距，传输介质），如果目标物设置情况改变，应重新得到透过率修正参数。

需设置参数：① 经过几何校正后的圆盘目标物待透过率校正的光谱图片文件夹路径ImageInputFolder
                       ② 基准参考波长BaseWavelength，该波段得图片不会经几何变换，其他波段的图片向该波段校准。

 保存：① 得到透过率校正系数a.mat